<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Farmer-Bidder Chat</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css">
</head>
<body class="bg-green-50 flex flex-col h-screen">

  <!-- HEADER -->
  <div class="bg-green-700 text-white p-4 flex justify-between items-center">
    <h2 class="text-xl font-semibold">ğŸŒ¾ Crop Chat</h2>
    <button id="backBtn" class="bg-white text-green-700 px-3 py-1 rounded">â¬… Back</button>
  </div>

  <!-- CHAT WINDOW -->
  <div id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-2"></div>

  <!-- MESSAGE INPUT -->
  <div class="p-4 bg-white border-t flex items-center">
    <input id="messageInput" type="text" placeholder="Type your message..."
      class="flex-1 border rounded-lg px-3 py-2 focus:outline-none">
    <button id="sendBtn" class="ml-3 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
      Send
    </button>
  </div>

  <script>
    // server-provided variables (Jinja)
    const cropId = "{{ crop_id }}";
    const serverPartnerId = "{{ partner_id | default('', true) }}";
    const serverPartnerName = "{{ partner_name | default('', true) }}";
    const senderId = "{{ user.id if user else '' }}";

    // fallback to localStorage if server didn't provide partner (keeps backwards compatibility)
    const receiverId = serverPartnerId || localStorage.getItem('chatReceiver');
    const receiverName = serverPartnerName || localStorage.getItem('chatReceiverName') || 'Partner';

    const API_BASE = window.location.origin + '/api/messages';
    const chatBox = document.getElementById('chatBox');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const backBtn = document.getElementById('backBtn');

    async function loadMessages() {
      if (!cropId) return;
      try {
        const res = await fetch(`${API_BASE}/${cropId}`);
        if (!res.ok) throw new Error('Failed to load messages');
        const data = await res.json();
        chatBox.innerHTML = '';
        data.forEach(msg => {
          const mine = msg.sender_id === senderId;
          const msgEl = document.createElement('div');
          msgEl.className = `max-w-xs px-3 py-2 rounded-lg text-sm shadow ${mine ? 'bg-green-600 text-white self-end ml-auto' : 'bg-gray-200 text-gray-900'}`;
          msgEl.textContent = msg.message;
          chatBox.appendChild(msgEl);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (e) {
        console.error(e);
      }
    }

    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return alert('Type a message');
      if (!senderId || !receiverId || !cropId) {
        return alert('Chat not properly initialized (missing sender/receiver/crop).');
      }
      try {
        await fetch(API_BASE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            crop_id: cropId,
            sender_id: senderId,
            receiver_id: receiverId,
            message: text
          })
        });
        messageInput.value = '';
        loadMessages();
      } catch (e) {
        console.error(e);
        alert('Failed to send message.');
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
    backBtn.addEventListener('click', () => window.history.back());

    // refresh every 2.5s
    setInterval(loadMessages, 2500);
    loadMessages();
  </script>
</body>
</html>
